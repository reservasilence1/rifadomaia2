<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pagamento PIX</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f3f5f4;--card:#fff;--borda:#e8ebea;--verde:#42761d;--txt:#1f2a1e;--sub:#6b776a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt)}
    .wrapper{max-width:560px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--borda);border-radius:14px;box-shadow:0 8px 24px rgba(16,24,40,.06);padding:18px}
    .titulo{font-weight:800;text-align:center;margin:6px 0 2px}
    .sub{font-size:13px;color:var(--sub);text-align:center;margin-bottom:12px}
    .qrWrap{display:flex;flex-direction:column;align-items:center;gap:12px}
    .qr{width:260px;height:260px;border-radius:12px;border:1px solid #ecf0ec;object-fit:contain;background:#fff}
    .valor{font-weight:800;font-size:18px;color:#111;text-align:center;margin-top:4px}
    .pixBox{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f7faf6;border:1px dashed #d7e4d3;border-radius:10px;padding:10px;word-break:break-all;width:100%}
    .btns{display:flex;gap:8px;width:100%}
    .btn{flex:1;height:46px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
    .btn.copy{background:#fff;border:2px solid var(--verde);color:var(--verde)}
    .btn.ok{background:var(--verde);color:#fff}
    .info{font-size:13px;color:var(--sub);text-align:center;margin-top:8px;line-height:1.5}
    .rodape{display:flex;justify-content:center;margin-top:14px}
    .rodape img{height:70px;opacity:.85}
    .ref{font-size:12px;color:#777;text-align:center;margin-top:8px}
    .status{margin-top:10px;font-size:13px;color:#555;text-align:center}
    .headerTopo{background:#fff;padding:12px 0;border-bottom:1px solid #e5e7eb}
    .headerWrap{max-width:880px;margin:0 auto;padding:0 16px;display:flex;justify-content:space-between;align-items:center}
    .headerLogo{height:35px}
    .btnMinhas{padding:10px 22px;border-radius:999px;border:2px solid #1d4ed8;background:#fff;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;color:#1d4ed8}
  </style>
</head>

<body>

<script>
  window.pixelId = "693cab59f3b93a26dfc078ad";
  var a = document.createElement("script");
  a.setAttribute("async", "");
  a.setAttribute("defer", "");
  a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
  document.head.appendChild(a);
</script>

<script
  src="https://cdn.utmify.com.br/scripts/utms/latest.js"
  data-utmify-prevent-xcod-sck
  data-utmify-prevent-subids
  async
  defer
></script>
  
  <div class="wrapper">
    <header class="headerTopo">
      <div class="headerWrap">
        <img src="images/logo.png" class="headerLogo" alt="Logo">
        <button id="btnMinhas" class="btnMinhas" type="button">Minhas compras</button>
      </div>
    </header>

    <div class="card">
      <div class="titulo">Pagamento via Pix</div>
      <div id="nomeLinha" class="sub"></div>

      <div class="qrWrap">
        <img id="qrImg" class="qr" alt="QR Code Pix">
        <div id="valorLinha" class="valor"></div>
        <div id="pixCode" class="pixBox"></div>

        <div class="btns">
          <button id="copiar" class="btn copy" type="button">Copiar código</button>
          <button id="paguei" class="btn ok" type="button">Já paguei</button>
        </div>

        <div class="info">
          Abra o app do seu banco, escolha <b>Pix</b>, selecione <b>Pix Copia e Cola</b>
          e cole o código acima ou escaneie o QR Code.
        </div>

        <div id="refLinha" class="ref"></div>
        <div id="statusLinha" class="status"></div>
      </div>
    </div>

    <div class="rodape"><img src="images/logo.png" alt="Logo"></div>
  </div>

  <script>
    function brl(v){ return "R$ " + Number(v).toFixed(2).replace(".", ","); }
    function maskCpf(c){
      const d = String(c || "").replace(/\D/g,"");
      if (d.length < 5) return c || "";
      return d.slice(0,3) + ".***.***-" + d.slice(-2);
    }

    function ensureDataUriBase64(maybeBase64){
      if (!maybeBase64) return "";
      if (/^data:image\//i.test(maybeBase64)) return maybeBase64;
      // base64 “puro”
      if (/^[A-Za-z0-9+/=]+$/.test(maybeBase64)) return "data:image/png;base64," + maybeBase64;
      // pode ser URL
      return maybeBase64;
    }

    function setQrFromPixCode(pixCode){
      // gera QR a partir do texto copia-e-cola (mais confiável)
      // (quickchart às vezes falha/limita; qrserver costuma ser mais estável)
      const url = "https://api.qrserver.com/v1/create-qr-code/?size=420x420&data=" + encodeURIComponent(pixCode);
      document.getElementById("qrImg").src = url;
    }

    const clienteRaw = localStorage.getItem("cliente");
    const pixRaw = localStorage.getItem("pix");

    if (!clienteRaw || !pixRaw) window.location.href = "index.html";

    const cliente = JSON.parse(clienteRaw || "{}");
    const pixObj = JSON.parse(pixRaw || "{}");

    // Pega o “copia e cola”
    const qrcode =
      pixObj?.pix?.qrcode ||
      pixObj?.pixCode ||
      pixObj?.pixcode ||
      pixObj?.qrcode ||
      "";

    // Se existir imagem pronta (caso a API mande)
    const qrImgApi =
      pixObj?.pix?.qrcode_image ||
      pixObj?.pix?.qrCodeImage ||
      pixObj?.qrCodeImage ||
      pixObj?.qrCodeUrl ||
      pixObj?.pix?.qrCodeUrl ||
      "";

    const transactionId =
      pixObj?.pix?.transactionId ||
      pixObj?.transactionId ||
      pixObj?.transactionID ||
      null;

    const nomeCurto = cliente?.nome ? cliente.nome.split(" ").slice(0,2).join(" ") : "";
    document.getElementById("nomeLinha").textContent =
      nomeCurto ? (nomeCurto + " • CPF " + maskCpf(cliente.cpf)) : "";

    document.getElementById("valorLinha").textContent = brl(cliente.valor || 0);
    document.getElementById("pixCode").textContent = qrcode || "PIX não encontrado. Volte e gere novamente.";

    // QR: tenta imagem da API; se não tiver, gera a partir do copia e cola
    const qrFixed = ensureDataUriBase64(qrImgApi);
    if (qrFixed) {
      document.getElementById("qrImg").src = qrFixed;
    } else if (qrcode) {
      setQrFromPixCode(qrcode);
    } else {
      // evita ícone de imagem quebrada
      document.getElementById("qrImg").removeAttribute("src");
    }

    // Referência
    if (transactionId) {
      document.getElementById("refLinha").textContent = "Referência: " + transactionId;
    } else {
      document.getElementById("refLinha").textContent = "";
    }

    // Botões
    document.getElementById("copiar").addEventListener("click", async () => {
      if (!qrcode) { alert("Código Pix não encontrado."); return; }
      try {
        await navigator.clipboard.writeText(qrcode);
        alert("Código Pix copiado!");
      } catch (e) {
        const ta = document.createElement("textarea");
        ta.value = qrcode;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        alert("Código Pix copiado!");
      }
    });

    document.getElementById("btnMinhas").addEventListener("click", () => {
      // se quiser, aponte para sua “sucesso.html” (minhas compras)
      window.location.href = "sucesso.html";
    });

    const statusEl = document.getElementById("statusLinha");

    let checking = false;
    async function checarStatus() {
      if (checking) return;

      if (!transactionId) {
        statusEl.textContent = "Status: aguardando referência da transação...";
        return;
      }

      checking = true;
      try {
        const r = await fetch("/api/pix-status?id=" + encodeURIComponent(transactionId), {
          cache: "no-store"
        });

        const s = await r.json().catch(() => null);

        if (s?.status) {
          statusEl.textContent = "Status: " + s.status;
        } else if (s?.error) {
          statusEl.textContent = "Status: " + s.error;
        } else {
          statusEl.textContent = "Status: aguardando confirmação...";
        }

        // Duttyfy: PENDING | COMPLETED
        if (String(s?.status || "").toUpperCase() === "COMPLETED") {
          window.location.href = "sucesso.html";
        }
      } catch (e) {
        // silencioso
      } finally {
        checking = false;
      }
    }

    document.getElementById("paguei").addEventListener("click", checarStatus);

    // auto-check
    checarStatus();
    setInterval(checarStatus, 4000);
  </script>
</body>
</html>
